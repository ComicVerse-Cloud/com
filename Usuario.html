<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Usuario - ComicVerse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --orange-cr: #F47521;
            --dark-bg: #000000;
            --neon-glow: 0 0 10px rgba(244, 117, 33, 0.5), 0 0 20px rgba(244, 117, 33, 0.3);
        }
        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* --- Animaciones --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }

        /* --- Tarjeta 3D (Flip Card) --- */
        .card-scene { perspective: 1000px; width: 100%; height: 250px; cursor: grab; }
        .card-obj {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 16px;
        }
        .card-obj.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 16px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
        }
        /* Cara Frontal (Info) */
        .card-front { 
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d); 
            border-bottom: 4px solid var(--orange-cr);
        }
        /* Cara Trasera (Membresía) */
        .card-back { 
            background: linear-gradient(135deg, #000000, #1a1a1a); 
            transform: rotateY(180deg); 
            position: relative; overflow: hidden;
        }
        
        /* Estilos Premium vs Basico */
        .status-premium {
            border: 2px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }
        .status-premium::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 70%);
            animation: rotateBg 10s linear infinite; pointer-events: none;
        }
        .status-basic { border: 2px solid #525252; }

        @keyframes rotateBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Badges / Títulos --- */
        .badge-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .badge {
            font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
            padding: 4px 10px; border-radius: 20px; border: 1px solid #333;
            background: #111; color: #777; transition: all 0.3s;
        }
        .badge.active {
            border-color: var(--orange-cr); color: white; background: rgba(244, 117, 33, 0.1);
            box-shadow: 0 0 10px rgba(244, 117, 33, 0.3);
        }

        /* --- Inputs --- */
        .input-cr {
            width: 100%; padding: 12px; background: #111; border: 1px solid #333;
            color: white; border-radius: 4px; outline: none; transition: 0.3s;
        }
        .input-cr:focus { border-color: var(--orange-cr); }

        /* --- Ocultar secciones --- */
        .hidden-section { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ======================= -->
    <!-- 1. SECCIÓN DE LOGIN/AUTH -->
    <!-- ======================= -->
    <div id="auth-container" class="w-full max-w-md animate-enter">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black italic tracking-tighter mb-2">COMIC<span class="text-[#F47521]">VERSE</span></h1>
            <p class="text-gray-400 text-sm">Identifícate para acceder al Multiverso</p>
        </div>

        <div class="bg-[#1a1a1a] p-8 rounded-xl border border-white/10 shadow-2xl relative overflow-hidden">
            <!-- Pestañas -->
            <div class="flex mb-6 border-b border-white/10">
                <button onclick="switchTab('login')" id="tab-login" class="flex-1 pb-2 font-bold text-[#F47521] border-b-2 border-[#F47521]">LOGIN</button>
                <button onclick="switchTab('register')" id="tab-register" class="flex-1 pb-2 font-bold text-gray-500 hover:text-white transition">REGISTRO</button>
            </div>

            <!-- Formulario Login -->
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Correo Electrónico" class="input-cr" required>
                <input type="password" id="login-pass" placeholder="Contraseña" class="input-cr" required>
                <button type="submit" class="w-full bg-[#F47521] hover:bg-orange-600 text-black font-black uppercase py-3 rounded transition hover:scale-[1.02]">
                    Ingresar
                </button>
            </form>

            <!-- Formulario Registro (Oculto por defecto) -->
            <form id="register-form" class="space-y-4 hidden-section">
                <input type="text" id="reg-username" placeholder="Nombre de Usuario (Único)" class="input-cr" required>
                <input type="email" id="reg-email" placeholder="Correo Electrónico" class="input-cr" required>
                <input type="password" id="reg-pass" placeholder="Contraseña (Mín 6 caracteres)" class="input-cr" required>
                <button type="submit" class="w-full bg-white hover:bg-gray-200 text-black font-black uppercase py-3 rounded transition hover:scale-[1.02]">
                    Crear Cuenta
                </button>
            </form>

            <div class="my-6 flex items-center justify-between text-gray-500 text-xs uppercase">
                <span class="w-1/3 h-px bg-white/10"></span>
                <span>O conecta con</span>
                <span class="w-1/3 h-px bg-white/10"></span>
            </div>

            <button onclick="googleLogin()" class="w-full bg-black border border-white/20 hover:border-white text-white font-bold py-3 rounded flex items-center justify-center gap-3 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Google
            </button>
        </div>
    </div>

    <!-- ======================= -->
    <!-- 2. SECCIÓN DE PERFIL -->
    <!-- ======================= -->
    <div id="profile-container" class="w-full max-w-4xl hidden-section animate-enter">
        
        <!-- Header Perfil -->
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-3xl font-black italic uppercase">Mi <span class="text-[#F47521]">Perfil</span></h2>
                <p class="text-xs text-gray-500 font-mono" id="profile-id">ID: Cargando...</p>
            </div>
            <button onclick="cerrarSesion()" class="text-red-500 text-xs font-bold uppercase hover:underline">
                <i class="fa-solid fa-power-off"></i> Cerrar Sesión
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- COLUMNA IZQUIERDA: Tarjeta 3D y Datos -->
            <div class="md:col-span-1 space-y-6">
                
                <!-- Tarjeta 3D Giratoria -->
                <div class="card-scene" onclick="this.querySelector('.card-obj').classList.toggle('is-flipped')">
                    <div class="card-obj" id="membership-card">
                        <!-- Frente -->
                        <div class="card-face card-front">
                            <div class="relative mb-4">
                                <img id="display-avatar" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full border-2 border-white object-cover">
                                <button onclick="toggleEditMode()" class="absolute bottom-0 right-0 bg-[#F47521] text-black w-8 h-8 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                            <h3 id="display-username" class="text-xl font-bold text-white">Usuario</h3>
                            <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest"><i class="fa-solid fa-rotate mr-1"></i> Toca para ver Membresía</p>
                        </div>
                        <!-- Atrás -->
                        <div class="card-face card-back status-basic" id="card-back-style">
                            <i id="badge-icon" class="fa-solid fa-user text-4xl mb-2 text-gray-500"></i>
                            <h3 id="membership-type" class="text-2xl font-black uppercase text-gray-400">Básico</h3>
                            <p class="text-[10px] text-gray-500 mt-2 px-4 text-center">Mejora a Premium para desbloquear contenido exclusivo.</p>
                        </div>
                    </div>
                </div>

                <!-- Bio -->
                <div class="bg-[#111] p-4 rounded-lg border border-white/5">
                    <h4 class="text-[#F47521] text-xs font-bold uppercase mb-2">Biografía</h4>
                    <p id="display-bio" class="text-sm text-gray-300 italic">Sin biografía.</p>
                    <!-- Editor Oculto -->
                    <div id="editor-area" class="hidden mt-4 pt-4 border-t border-white/10">
                        <input type="text" id="edit-photo" placeholder="URL Foto Perfil" class="input-cr mb-2 text-xs">
                        <textarea id="edit-bio" placeholder="Escribe tu bio..." class="input-cr h-20 text-xs mb-2"></textarea>
                        <button onclick="guardarPerfil()" class="w-full bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded">GUARDAR CAMBIOS</button>
                    </div>
                </div>

            </div>

            <!-- COLUMNA DERECHA: Títulos y Admin -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- Títulos de Comunidad -->
                <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-medal text-yellow-500"></i> Títulos Obtenidos
                    </h3>
                    <div class="badge-grid" id="titles-container">
                        <!-- Se llenan con JS -->
                        <span class="badge">Creador</span>
                        <span class="badge">Crítico</span>
                        <span class="badge">Votante</span>
                        <span class="badge">VIP</span>
                        <span class="badge">Beta Tester</span>
                        <span class="badge">Donador</span>
                        <span class="badge">Leyenda</span>
                        <span class="badge">Otaku</span>
                        <span class="badge">Artista</span>
                        <span class="badge">Moderador</span>
                        <span class="badge">Explorador</span>
                        <span class="badge">Coleccionista</span>
                        <span class="badge">Maestro</span>
                        <span class="badge">Fan #1</span>
                        <span class="badge">Guionista</span>
                        <span class="badge">Traductor</span>
                        <span class="badge">Editor</span>
                        <span class="badge">Héroe</span>
                        <span class="badge">Villano</span>
                        <span class="badge">Dios</span>
                    </div>
                </div>

                <!-- Panel de Administrador (Secreto) -->
                <div class="bg-black p-6 rounded-xl border border-red-900/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-red-500 uppercase tracking-widest"><i class="fa-solid fa-user-secret"></i> Zona Admin</h3>
                        <input type="password" id="admin-key" placeholder="Clave de Acceso" class="bg-[#111] border border-red-900/50 text-red-500 text-xs px-2 py-1 rounded w-32 text-center" onkeyup="checkAdmin()">
                    </div>

                    <div id="admin-controls" class="hidden-section space-y-4 border-t border-red-900/20 pt-4">
                        <p class="text-xs text-gray-500">Editando al usuario actual (Tú)</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Membresía</label>
                                <button onclick="setPremium(true)" class="w-full bg-yellow-600/20 text-yellow-500 border border-yellow-600/50 text-xs font-bold py-2 rounded mb-2 hover:bg-yellow-600 hover:text-black">Hacer Premium</button>
                                <button onclick="setPremium(false)" class="w-full bg-gray-800 text-gray-400 border border-gray-600 text-xs font-bold py-2 rounded hover:bg-white hover:text-black">Hacer Básico</button>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Asignar Título</label>
                                <select id="admin-title-select" class="w-full bg-[#111] text-white text-xs p-2 rounded border border-gray-700 mb-2">
                                    <option value="Creador">Creador</option>
                                    <option value="Crítico">Crítico</option>
                                    <option value="Votante">Votante</option>
                                    <option value="Leyenda">Leyenda</option>
                                    <option value="Dios">Dios</option>
                                    <!-- Agregar más si se quiere -->
                                </select>
                                <button onclick="addTitleToUser()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 rounded">Asignar</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- LOGICA FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf9ATqgErKQKpzKpFXsUu4BHmFcNSLzOE",
            authDomain: "comic-a54bf.firebaseapp.com",
            projectId: "comic-a54bf",
            storageBucket: "comic-a54bf.firebasestorage.app",
            messagingSenderId: "653412030846",
            appId: "1:653412030846:web:86f30b301d3c8c41e1fb2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;

        // --- MANEJO DE ESTADO (LOGIN vs PERFIL) ---
        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('auth-container');
            const profileContainer = document.getElementById('profile-container');

            if (user) {
                // Usuario logueado
                currentUserUid = user.uid;
                authContainer.classList.add('hidden-section');
                profileContainer.classList.remove('hidden-section');
                await cargarDatosPerfil(user);
            } else {
                // No hay usuario
                currentUserUid = null;
                authContainer.classList.remove('hidden-section');
                profileContainer.classList.add('hidden-section');
            }
        });

        // --- FUNCIONES DE AUTENTICACIÓN ---
        
        window.switchTab = (tab) => {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabReg = document.getElementById('tab-register');

            if (tab === 'login') {
                loginForm.classList.remove('hidden-section');
                regForm.classList.add('hidden-section');
                tabLogin.className = "flex-1 pb-2 font-bold text-[#F47521] border-b-2 border-[#F47521]";
                tabReg.className = "flex-1 pb-2 font-bold text-gray-500 hover:text-white transition";
            } else {
                loginForm.classList.add('hidden-section');
                regForm.classList.remove('hidden-section');
                tabReg.className = "flex-1 pb-2 font-bold text-[#F47521] border-b-2 border-[#F47521]";
                tabLogin.className = "flex-1 pb-2 font-bold text-gray-500 hover:text-white transition";
            }
        };

        // Login Email
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                alert("Error al ingresar: " + error.message);
            }
        });

        // Registro Email
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const username = document.getElementById('reg-username').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                
                // Guardar username en Auth Profile
                await updateProfile(user, { displayName: username });

                // Crear documento en Firestore
                await setDoc(doc(db, "users", user.uid), {
                    username: username,
                    email: email,
                    photoURL: "https://via.placeholder.com/150",
                    bio: "Nuevo en ComicVerse",
                    titles: ["Novato"],
                    isPremium: false
                });

            } catch (error) {
                alert("Error al registrar: " + error.message);
            }
        });

        // Google Login
        window.googleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Verificar si existe en DB, si no, crear
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    await setDoc(docRef, {
                        username: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        bio: "Nuevo en ComicVerse",
                        titles: ["Novato"],
                        isPremium: false
                    });
                }
            } catch (error) {
                alert("Error Google: " + error.message);
            }
        };

        window.cerrarSesion = () => signOut(auth);

        // --- GESTIÓN DE PERFIL (FIRESTORE) ---

        async function cargarDatosPerfil(user) {
            document.getElementById('profile-id').innerText = "ID: " + user.uid.substring(0, 8) + "...";
            
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Renderizar Datos
                document.getElementById('display-username').innerText = data.username;
                document.getElementById('display-bio').innerText = data.bio || "Sin bio.";
                document.getElementById('display-avatar').src = data.photoURL || "https://via.placeholder.com/150";
                
                // Renderizar Tarjeta 3D (Premium/Básico)
                renderCardStatus(data.isPremium);

                // Renderizar Títulos
                renderTitles(data.titles || []);

                // Pre-llenar editor
                document.getElementById('edit-bio').value = data.bio || "";
                document.getElementById('edit-photo').value = data.photoURL || "";
                
                // Guardar avatar en LocalStorage para usar en index.html/comics.html
                localStorage.setItem('userAvatar', data.photoURL);

            } else {
                console.log("No se encontró perfil en DB");
            }
        }

        function renderCardStatus(isPremium) {
            const cardBack = document.getElementById('card-back-style');
            const typeText = document.getElementById('membership-type');
            const icon = document.getElementById('badge-icon');

            if (isPremium) {
                cardBack.className = "card-face card-back status-premium";
                typeText.innerText = "PREMIUM";
                typeText.className = "text-2xl font-black uppercase text-[#F47521] drop-shadow-md";
                icon.className = "fa-solid fa-crown text-5xl mb-2 text-yellow-400 animate-pulse";
            } else {
                cardBack.className = "card-face card-back status-basic";
                typeText.innerText = "BÁSICO";
                typeText.className = "text-2xl font-black uppercase text-gray-400";
                icon.className = "fa-solid fa-user text-4xl mb-2 text-gray-500";
            }
        }

        function renderTitles(userTitles) {
            const allBadges = document.querySelectorAll('.badge');
            allBadges.forEach(badge => {
                const titleName = badge.innerText;
                if (userTitles.includes(titleName)) {
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            });
        }

        // --- EDICIÓN DE PERFIL ---
        window.toggleEditMode = () => {
            const editor = document.getElementById('editor-area');
            editor.classList.toggle('hidden');
        };

        window.guardarPerfil = async () => {
            if (!currentUserUid) return;
            
            const newBio = document.getElementById('edit-bio').value;
            const newPhoto = document.getElementById('edit-photo').value;
            
            try {
                await updateDoc(doc(db, "users", currentUserUid), {
                    bio: newBio,
                    photoURL: newPhoto
                });
                // Recargar interfaz
                const user = auth.currentUser;
                await cargarDatosPerfil(user);
                window.toggleEditMode();
                alert("Perfil actualizado");
            } catch (e) {
                alert("Error al guardar: " + e.message);
            }
        };

        // --- PANEL DE ADMIN (CLAVE #Lau3700#) ---
        
        window.checkAdmin = () => {
            const key = document.getElementById('admin-key').value;
            if (key === "#Lau3700#") {
                document.getElementById('admin-controls').classList.remove('hidden-section');
            } else {
                document.getElementById('admin-controls').classList.add('hidden-section');
            }
        };

        window.setPremium = async (status) => {
            if (!currentUserUid) return;
            try {
                await updateDoc(doc(db, "users", currentUserUid), { isPremium: status });
                // Actualizar visualmente sin recargar
                renderCardStatus(status);
                alert(`Usuario ahora es ${status ? 'PREMIUM' : 'BÁSICO'}`);
            } catch (e) { console.error(e); }
        };

        window.addTitleToUser = async () => {
            if (!currentUserUid) return;
            const title = document.getElementById('admin-title-select').value;
            try {
                await updateDoc(doc(db, "users", currentUserUid), {
                    titles: arrayUnion(title)
                });
                // Recargar visualmente
                const currentTitles = document.querySelectorAll('.badge.active');
                // Truco rápido: Recargar todo el perfil es más seguro
                cargarDatosPerfil(auth.currentUser);
                alert(`Título "${title}" asignado.`);
            } catch (e) { console.error(e); }
        };

    </script>
</body>
</html>

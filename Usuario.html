<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Usuario - ComicVerse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --orange-cr: #F47521;
            --dark-bg: #000000;
            --neon-glow: 0 0 10px rgba(244, 117, 33, 0.5), 0 0 20px rgba(244, 117, 33, 0.3);
        }
        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* --- Animaciones --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }

        /* --- MARCOS DE PERFIL (COLECCIÓN ULTIMATE) --- */
        .avatar-container { position: relative; display: inline-block; padding: 6px; border-radius: 50%; box-sizing: border-box; }
        .profile-img { border-radius: 50%; border: 3px solid #1a1a1a; position: relative; z-index: 2; width: 6rem; height: 6rem; object-fit: cover; }

        /* Legacy Keepers */
        .frame-gold { background: linear-gradient(45deg, #FFD700, #FDB931, #FFD700); animation: spin 4s linear infinite; box-shadow: 0 0 15px #FFD700; }
        .frame-neon { background: linear-gradient(90deg, #00f2ff, #001eff); animation: pulse-blue 2s infinite; box-shadow: 0 0 15px #00f2ff; }
        .frame-fire { background: linear-gradient(0deg, #ff0000, #ffae00); box-shadow: 0 -5px 20px #ff4500; animation: shake 3s infinite; }
        .frame-glitch { border: 3px solid #00ff00; box-shadow: 2px 2px #ff00de, -2px -2px #00ffff; }

        /* NEW FRAMES */
        .frame-cosmic { background: linear-gradient(135deg, #663399, #000000, #4b0082); box-shadow: 0 0 20px #9400d3; animation: spin-slow 8s linear infinite; border: 2px dashed rgba(255,255,255,0.5); }
        .frame-plasma { background: conic-gradient(#ff00ff, #00ffff, #ff00ff); animation: spin 2s linear infinite; filter: blur(1px); }
        .frame-matrix { background: #000; border: 2px solid #0f0; box-shadow: inset 0 0 10px #0f0, 0 0 10px #0f0; }
        .frame-blood { background: radial-gradient(circle, #8a0303, #000); border: 2px solid #ff0000; box-shadow: 0 0 15px #ff0000; animation: pulse-red 3s infinite; }
        .frame-holo { background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(255,255,255,0)); border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 0 20px rgba(0,255,255,0.5); backdrop-filter: hue-rotate(90deg); }
        .frame-radioactive { background: repeating-linear-gradient(45deg, #ffeb3b, #ffeb3b 10px, #000 10px, #000 20px); border: 2px solid #ffeb3b; box-shadow: 0 0 10px #ffeb3b; }
        .frame-spirit { background: linear-gradient(to top, #00ffff, transparent); box-shadow: 0 -10px 20px #00ffff; animation: float 3s ease-in-out infinite; }
        .frame-steampunk { background: #cd7f32; border: 4px ridge #8b4513; box-shadow: inset 0 0 10px #000; }
        .frame-pixel { border: 4px dashed #fff; box-shadow: 4px 4px 0 #F47521, -4px -4px 0 #00f2ff; }
        .frame-angel { background: white; box-shadow: 0 0 25px white, 0 0 50px #fffacd; border: 2px solid #fffacd; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 10px #00f2ff; } 50% { box-shadow: 0 0 25px #00f2ff; } 100% { box-shadow: 0 0 10px #00f2ff; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 25px #ff0000; } 100% { box-shadow: 0 0 5px #ff0000; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- Tarjeta 3D (Flip Card) --- */
        .card-scene { perspective: 1000px; width: 100%; height: 250px; cursor: grab; }
        .card-obj {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 16px;
        }
        .card-obj.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 16px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
        }
        .card-front { background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-bottom: 4px solid var(--orange-cr); }
        .card-back { background: linear-gradient(135deg, #000000, #1a1a1a); transform: rotateY(180deg); position: relative; overflow: hidden; }
        
        .status-premium { border: 2px solid #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        .status-premium::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 70%);
            animation: rotateBg 10s linear infinite; pointer-events: none;
        }
        .status-basic { border: 2px solid #525252; }
        @keyframes rotateBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Badges / Títulos Mejorados --- */
        .badge-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .badge {
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
            padding: 4px 10px; border-radius: 4px; border: 1px solid #333;
            background: #0a0a0a; color: #444; transition: all 0.3s;
            filter: grayscale(100%); opacity: 0.5;
        }
        
        .badge.owned { filter: grayscale(0%); opacity: 1; border-color: transparent; color: white; transform: scale(1.05); }
        
        .badge[data-title="Creador"].owned { background: linear-gradient(90deg, #F47521, #ff4500); box-shadow: 0 0 10px #ff4500; }
        .badge[data-title="Dios"].owned { background: linear-gradient(90deg, #fff, #ffd700); color: black; box-shadow: 0 0 15px white; animation: pulseGold 2s infinite; }
        .badge[data-title="VIP"].owned { background: #6d28d9; border: 1px solid #a78bfa; }
        .badge[data-title="Artista"].owned { background: #ec4899; }
        .badge[data-title="Héroe"].owned { background: #3b82f6; }
        .badge[data-title="Villano"].owned { background: #ef4444; }

        @keyframes pulseGold { 0% { box-shadow: 0 0 5px #ffd700; } 50% { box-shadow: 0 0 20px #ffd700; } 100% { box-shadow: 0 0 5px #ffd700; } }

        /* --- Inputs --- */
        .input-cr {
            width: 100%; padding: 12px; background: #111; border: 1px solid #333;
            color: white; border-radius: 4px; outline: none; transition: 0.3s;
        }
        .input-cr:focus { border-color: var(--orange-cr); }

        /* --- Tabla Admin --- */
        .admin-table-container { max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; border-radius: 4px; }
        .admin-table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.8rem; }
        .admin-table th { background: #222; color: #aaa; padding: 8px; position: sticky; top: 0; }
        .admin-table td { border-bottom: 1px solid #222; padding: 8px; color: #ddd; }
        .admin-table tr:hover { background: rgba(244, 117, 33, 0.1); cursor: pointer; }
        .admin-table tr.selected { background: rgba(244, 117, 33, 0.3); border-left: 3px solid var(--orange-cr); }

        /* --- Paneles Modales --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background: #111; border: 2px solid #333; padding: 2rem; border-radius: 1rem;
            max-width: 400px; width: 90%; text-align: center; animation: bounceIn 0.3s;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .hidden-section { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- LOGIN/AUTH -->
    <div id="auth-container" class="w-full max-w-md animate-enter">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black italic tracking-tighter mb-2">COMIC<span class="text-[#F47521]">VERSE</span></h1>
            <p class="text-gray-400 text-sm">Identifícate para acceder al Multiverso</p>
        </div>

        <div class="bg-[#1a1a1a] p-8 rounded-xl border border-white/10 shadow-2xl relative overflow-hidden">
            <div class="flex mb-6 border-b border-white/10">
                <button onclick="switchTab('login')" id="tab-login" class="flex-1 pb-2 font-bold text-[#F47521] border-b-2 border-[#F47521]">LOGIN</button>
                <button onclick="switchTab('register')" id="tab-register" class="flex-1 pb-2 font-bold text-gray-500 hover:text-white transition">REGISTRO</button>
            </div>

            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Correo Electrónico" class="input-cr" required>
                <input type="password" id="login-pass" placeholder="Contraseña" class="input-cr" required>
                <button type="submit" class="w-full bg-[#F47521] hover:bg-orange-600 text-black font-black uppercase py-3 rounded transition hover:scale-[1.02]">Ingresar</button>
            </form>

            <form id="register-form" class="space-y-4 hidden-section">
                <input type="text" id="reg-username" placeholder="Nombre de Usuario (Único)" class="input-cr" required>
                <input type="email" id="reg-email" placeholder="Correo Electrónico" class="input-cr" required>
                <input type="password" id="reg-pass" placeholder="Contraseña (Mín 6 caracteres)" class="input-cr" required>
                <button type="submit" class="w-full bg-white hover:bg-gray-200 text-black font-black uppercase py-3 rounded transition hover:scale-[1.02]">Crear Cuenta</button>
            </form>

            <div class="my-6 flex items-center justify-between text-gray-500 text-xs uppercase">
                <span class="w-1/3 h-px bg-white/10"></span><span>O conecta con</span><span class="w-1/3 h-px bg-white/10"></span>
            </div>

            <button onclick="googleLogin()" class="w-full bg-black border border-white/20 hover:border-white text-white font-bold py-3 rounded flex items-center justify-center gap-3 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google
            </button>
        </div>
    </div>

    <!-- PERFIL -->
    <div id="profile-container" class="w-full max-w-4xl hidden-section animate-enter">
        
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-3xl font-black italic uppercase">Mi <span class="text-[#F47521]">Perfil</span></h2>
                <p class="text-xs text-gray-500 font-mono" id="profile-id">ID: Cargando...</p>
            </div>
            <button onclick="cerrarSesion()" class="text-red-500 text-xs font-bold uppercase hover:underline"><i class="fa-solid fa-power-off"></i> Cerrar Sesión</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- COLUMNA IZQUIERDA -->
            <div class="md:col-span-1 space-y-6">
                <!-- Tarjeta 3D -->
                <div class="card-scene" onclick="this.querySelector('.card-obj').classList.toggle('is-flipped')">
                    <div class="card-obj" id="membership-card">
                        <!-- Frente -->
                        <div class="card-face card-front">
                            <div class="relative mb-4">
                                <div id="avatar-frame" class="avatar-container">
                                    <img id="display-avatar" src="https://via.placeholder.com/150" class="profile-img" onerror="this.src='https://via.placeholder.com/150'">
                                </div>
                                <button onclick="event.stopPropagation(); toggleEditMode()" class="absolute bottom-0 right-0 bg-[#F47521] text-black w-8 h-8 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg z-10"><i class="fa-solid fa-pen"></i></button>
                            </div>
                            <h3 id="display-username" class="text-xl font-bold text-white">Usuario</h3>
                            
                            <!-- Redes Sociales (Solo Creador) -->
                            <div id="social-buttons" class="flex gap-2 mt-3 hidden-section justify-center">
                                <a id="btn-tiktok" href="#" target="_blank" class="text-white hover:text-pink-500 text-lg transition p-2 bg-black/50 rounded-full"><i class="fa-brands fa-tiktok"></i></a>
                                <a id="btn-insta" href="#" target="_blank" class="text-white hover:text-purple-500 text-lg transition p-2 bg-black/50 rounded-full"><i class="fa-brands fa-instagram"></i></a>
                            </div>

                            <p class="text-xs text-gray-400 mt-2 uppercase tracking-widest"><i class="fa-solid fa-rotate mr-1"></i> Toca para ver Membresía</p>
                        </div>
                        <!-- Atrás -->
                        <div class="card-face card-back status-basic" id="card-back-style">
                            <i id="badge-icon" class="fa-solid fa-user text-4xl mb-2 text-gray-500"></i>
                            <h3 id="membership-type" class="text-2xl font-black uppercase text-gray-400">Básico</h3>
                            <p class="text-[10px] text-gray-500 mt-2 px-4 text-center">Mejora a Premium para desbloquear contenido exclusivo.</p>
                        </div>
                    </div>
                </div>

                <!-- Bio / Editor -->
                <div class="bg-[#111] p-4 rounded-lg border border-white/5">
                    <h4 class="text-[#F47521] text-xs font-bold uppercase mb-2">Biografía</h4>
                    <p id="display-bio" class="text-sm text-gray-300 italic">Sin biografía.</p>
                    
                    <!-- AREA EDICIÓN -->
                    <div id="editor-area" class="hidden mt-4 pt-4 border-t border-white/10">
                        <label class="text-[10px] text-gray-500 uppercase mb-1 block">Foto de Perfil</label>
                        <input type="text" id="edit-photo" placeholder="Pegar URL..." class="input-cr mb-2 text-xs">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] text-gray-500">O subir:</span>
                            <input type="file" id="file-upload" accept="image/*" class="text-xs text-gray-400">
                        </div>
                        
                        <label class="text-[10px] text-gray-500 uppercase mb-1 block">Biografía</label>
                        <textarea id="edit-bio" placeholder="Escribe tu bio..." class="input-cr h-20 text-xs mb-2"></textarea>
                        
                        <!-- Inputs Creador -->
                        <div id="creator-inputs" class="hidden-section border-t border-white/5 pt-2 mt-2">
                            <label class="text-[10px] text-[#F47521] uppercase mb-1 block font-bold">Zona Creador</label>
                            <input type="text" id="edit-tiktok" placeholder="URL TikTok" class="input-cr mb-2 text-xs">
                            <input type="text" id="edit-insta" placeholder="URL Instagram" class="input-cr mb-2 text-xs">
                        </div>

                        <div class="flex gap-2 mt-2">
                            <button onclick="guardarPerfil()" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded">GUARDAR</button>
                            <button onclick="toggleEditMode()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded">CANCELAR</button>
                        </div>
                        
                        <button onclick="confirmarBorrar()" class="w-full mt-4 bg-red-900/30 border border-red-800 text-red-500 hover:bg-red-900 hover:text-white text-xs font-bold py-2 rounded transition">[BORRAR CUENTA]</button>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA -->
            <div class="md:col-span-2 space-y-6">
                
                <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-medal text-yellow-500"></i> Títulos Obtenidos
                        </h3>
                        <span id="titles-count" class="text-xs bg-[#333] px-2 py-1 rounded text-white">0 / 20</span>
                    </div>
                    <div class="text-xs text-gray-500 mb-2 italic" id="default-title-msg"></div>
                    <div class="badge-grid" id="titles-container"></div>
                </div>

                <!-- ADMIN ZONE -->
                <div class="bg-black p-6 rounded-xl border border-red-900/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-red-500 uppercase tracking-widest"><i class="fa-solid fa-user-secret"></i> Zona Admin</h3>
                        <input type="password" id="admin-key" placeholder="Clave" class="bg-[#111] border border-red-900/50 text-red-500 text-xs px-2 py-1 rounded w-24 text-center" onkeyup="checkAdmin()">
                    </div>

                    <div id="admin-controls" class="hidden-section border-t border-red-900/20 pt-4">
                        <div class="mb-4">
                            <input type="text" id="admin-search" placeholder="Buscar Gmail..." class="w-full bg-[#111] border border-gray-700 text-white text-xs p-2 rounded mb-2" onkeyup="filtrarUsuarios()">
                            <div class="admin-table-container custom-scroll">
                                <table class="admin-table">
                                    <thead><tr><th>Usuario / Email</th><th>ID</th></tr></thead>
                                    <tbody id="users-table-body"><tr><td colspan="2" class="text-center py-2">Cargando...</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="admin-actions-panel" class="bg-[#1a1a1a] p-4 rounded border border-gray-700 opacity-50 pointer-events-none transition-opacity">
                            <p class="text-xs text-[#F47521] font-bold mb-2">Editando a: <span id="selected-user-email" class="text-white">Nadie</span></p>
                            <div class="flex gap-2 mb-4">
                                <button onclick="adminViewData()" class="flex-1 bg-blue-900/30 text-blue-400 border border-blue-500/30 text-xs font-bold py-2 rounded hover:bg-blue-600 hover:text-white"><i class="fa-solid fa-eye"></i> Ver Datos</button>
                                <button onclick="adminDeleteUser()" class="flex-1 bg-red-900/30 text-red-500 border border-red-500/30 text-xs font-bold py-2 rounded hover:bg-red-600 hover:text-white"><i class="fa-solid fa-trash"></i> Borrar Usuario</button>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Membresía</label>
                                    <button onclick="adminSetPremium(true)" class="w-full bg-yellow-600/20 text-yellow-500 border border-yellow-600/50 text-xs font-bold py-1 rounded mb-2 hover:bg-yellow-600 hover:text-black">Hacer PREMIUM</button>
                                    <button onclick="adminSetPremium(false)" class="w-full bg-gray-800 text-gray-400 border border-gray-600 text-xs font-bold py-1 rounded hover:bg-white hover:text-black">Hacer BÁSICO</button>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Asignar Título</label>
                                    <select id="admin-title-select" class="w-full bg-[#111] text-white text-xs p-1 rounded border border-gray-700 mb-2"></select>
                                    <button onclick="adminAddTitle()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-1 rounded">Asignar</button>
                                </div>
                            </div>
                            <div class="mt-4 border-t border-white/5 pt-2">
                                <label class="block text-[10px] text-gray-500 mb-1">Marco de Perfil (Frame)</label>
                                <div class="flex gap-2">
                                    <select id="admin-frame-select" class="flex-1 bg-[#111] text-white text-xs p-1 rounded border border-gray-700">
                                        <option value="">Ninguno</option>
                                        <option value="frame-gold">Golden God</option>
                                        <option value="frame-neon">Neon Cyber</option>
                                        <option value="frame-fire">Hell Fire</option>
                                        <option value="frame-glitch">Glitch Tech</option>
                                        <option value="frame-cosmic">Cosmic Stardust</option>
                                        <option value="frame-plasma">Plasma Flow</option>
                                        <option value="frame-matrix">Matrix Code</option>
                                        <option value="frame-blood">Blood Moon</option>
                                        <option value="frame-holo">Holographic</option>
                                        <option value="frame-steampunk">Steampunk</option>
                                        <option value="frame-pixel">Pixel Art</option>
                                        <option value="frame-radioactive">Radioactive</option>
                                        <option value="frame-spirit">Spirit Fire</option>
                                        <option value="frame-angel">Angel Wings</option>
                                    </select>
                                    <button onclick="adminSetFrame()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-1 px-3 rounded">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL DE NOTIFICACIÓN -->
    <div id="notification-modal" class="hidden-section modal-overlay">
        <div class="modal-content border-green-500 shadow-green-500/20">
            <i id="notif-icon" class="fa-solid fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h3 id="notif-title" class="text-2xl font-black text-white uppercase mb-2">Sistema</h3>
            <p id="notif-msg" class="text-gray-400 mb-6">Cambios guardados con éxito.</p>
            <button onclick="closeNotification()" class="bg-white text-black font-bold py-2 px-6 rounded uppercase hover:bg-gray-200">Aceptar</button>
        </div>
    </div>

    <!-- MODAL "TRAMPOSILLO" -->
    <div id="cheat-modal" class="hidden-section modal-overlay">
        <div class="modal-content border-red-600 shadow-red-600/30">
            <i class="fa-solid fa-ban text-5xl text-red-600 mb-4 animate-pulse"></i>
            <h3 class="text-2xl font-black text-white uppercase mb-2">¡Alto ahí!</h3>
            <p class="text-gray-400 mb-6">¿Qué tratas de hacer, tramposillo? <br>Ese no es un enlace válido de la plataforma.</p>
            <button onclick="closeCheatModal()" class="bg-red-600 text-white font-bold py-2 px-6 rounded uppercase hover:bg-red-500">Lo siento</button>
        </div>
    </div>

    <!-- LOGICA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf9ATqgErKQKpzKpFXsUu4BHmFcNSLzOE",
            authDomain: "comic-a54bf.firebaseapp.com",
            projectId: "comic-a54bf",
            storageBucket: "comic-a54bf.firebasestorage.app",
            messagingSenderId: "653412030846",
            appId: "1:653412030846:web:86f30b301d3c8c41e1fb2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;
        let allUsersCache = [];
        let selectedUserId = null;

        // UI HELPERS
        window.showNotification = (title, msg, type = 'success') => {
            const modal = document.getElementById('notification-modal');
            const content = modal.querySelector('.modal-content');
            const icon = document.getElementById('notif-icon');
            
            document.getElementById('notif-title').innerText = title;
            document.getElementById('notif-msg').innerText = msg;

            if(type === 'success') {
                content.className = "modal-content border-green-500 shadow-green-500/20";
                icon.className = "fa-solid fa-check-circle text-5xl text-green-500 mb-4";
            } else {
                content.className = "modal-content border-red-500 shadow-red-500/20";
                icon.className = "fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-4";
            }
            modal.classList.remove('hidden-section');
        };
        window.closeNotification = () => document.getElementById('notification-modal').classList.add('hidden-section');
        
        window.showCheatModal = () => document.getElementById('cheat-modal').classList.remove('hidden-section');
        window.closeCheatModal = () => document.getElementById('cheat-modal').classList.add('hidden-section');

        const ALL_TITLES = [
            { name: "Creador", type: "legendary" }, { name: "Dios", type: "legendary" }, { name: "Leyenda", type: "legendary" }, { name: "Fan #1", type: "legendary" },
            { name: "Héroe", type: "epic" }, { name: "Villano", type: "epic" }, { name: "VIP", type: "epic" }, { name: "Donador", type: "epic" }, { name: "Maestro", type: "epic" },
            { name: "Moderador", type: "rare" }, { name: "Artista", type: "rare" }, { name: "Editor", type: "rare" }, { name: "Guionista", type: "rare" }, { name: "Traductor", type: "rare" },
            { name: "Crítico", type: "common" }, { name: "Votante", type: "common" }, { name: "Beta Tester", type: "common" }, { name: "Otaku", type: "common" }, { name: "Explorador", type: "common" }, { name: "Coleccionista", type: "common" }
        ];

        const adminSelect = document.getElementById('admin-title-select');
        const titlesContainer = document.getElementById('titles-container');
        ALL_TITLES.forEach(t => {
            const opt = document.createElement('option'); opt.value = t.name; opt.innerText = t.name; adminSelect.appendChild(opt);
            const badge = document.createElement('span'); badge.className = `badge ${t.type}`; badge.dataset.title = t.name; badge.innerText = t.name; titlesContainer.appendChild(badge);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                document.getElementById('auth-container').classList.add('hidden-section');
                document.getElementById('profile-container').classList.remove('hidden-section');
                await cargarDatosPerfil(user);
            } else {
                currentUserUid = null;
                document.getElementById('auth-container').classList.remove('hidden-section');
                document.getElementById('profile-container').classList.add('hidden-section');
            }
        });

        window.switchTab = (tab) => {
            if (tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden-section');
                document.getElementById('register-form').classList.add('hidden-section');
                document.getElementById('tab-login').className = "flex-1 pb-2 font-bold text-[#F47521] border-b-2 border-[#F47521]";
                document.getElementById('tab-register').className = "flex-1 pb-2 font-bold text-gray-500 hover:text-white transition";
            } else {
                document.getElementById('login-form').classList.add('hidden-section');
                document.getElementById('register-form').classList.remove('hidden-section');
                document.getElementById('tab-register').className = "flex-1 pb-2 font-bold text-[#F47521] border-b-2 border-[#F47521]";
                document.getElementById('tab-login').className = "flex-1 pb-2 font-bold text-gray-500 hover:text-white transition";
            }
        };

        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } catch (e) { showNotification("Error", e.message, "error"); } });
        document.getElementById('register-form').addEventListener('submit', async (e) => { e.preventDefault(); const userVal = document.getElementById('reg-username').value; const emailVal = document.getElementById('reg-email').value; try { const cred = await createUserWithEmailAndPassword(auth, emailVal, document.getElementById('reg-pass').value); await updateProfile(cred.user, { displayName: userVal }); await setDoc(doc(db, "users", cred.user.uid), { username: userVal, email: emailVal, photoURL: "https://via.placeholder.com/150", bio: "Nuevo en ComicVerse", titles: [], isPremium: false }); } catch (e) { showNotification("Error", e.message, "error"); } });
        window.googleLogin = async () => { try { const res = await signInWithPopup(auth, provider); const userRef = doc(db, "users", res.user.uid); const snap = await getDoc(userRef); if(!snap.exists()) { await setDoc(userRef, { username: res.user.displayName, email: res.user.email, photoURL: res.user.photoURL, bio: "Nuevo en ComicVerse", titles: [], isPremium: false }); } } catch (e) { showNotification("Error", e.message, "error"); } };
        window.cerrarSesion = () => signOut(auth);

        async function cargarDatosPerfil(user) {
            document.getElementById('profile-id').innerText = "ID: " + user.uid.substring(0, 8) + "...";
            const snap = await getDoc(doc(db, "users", user.uid));
            if (snap.exists()) {
                // Si es admin cargando datos de otro, user no es auth.currentUser
                // Usamos los datos pasados como parametro (si es el usuario actual) o los del snapshot
                const data = snap.data();
                document.getElementById('display-username').innerText = data.username;
                document.getElementById('display-bio').innerText = data.bio || "Sin bio.";
                
                const photo = (data.photoURL && data.photoURL.trim() !== "") ? data.photoURL : "https://via.placeholder.com/150";
                document.getElementById('display-avatar').src = photo;
                
                // Solo guardar en local si es MI perfil
                if(auth.currentUser && auth.currentUser.uid === user.uid) {
                    localStorage.setItem('userAvatar', photo);
                }

                document.getElementById('avatar-frame').className = `avatar-container ${data.frame || ''}`;
                renderCardStatus(data.isPremium);
                
                const userTitles = data.titles || [];
                const badges = document.querySelectorAll('.badge');
                let count = 0;
                const msgEl = document.getElementById('default-title-msg');
                msgEl.innerText = userTitles.length === 0 ? "Nuevo usuario (Aún no tienes títulos)" : "";
                badges.forEach(b => { if (userTitles.includes(b.dataset.title)) { b.classList.add('owned'); count++; } else { b.classList.remove('owned'); } });
                document.getElementById('titles-count').innerText = `${count} / ${ALL_TITLES.length}`;

                if (userTitles.includes("Creador")) {
                    document.getElementById('creator-inputs').classList.remove('hidden-section');
                    document.getElementById('social-buttons').classList.remove('hidden-section');
                    document.getElementById('edit-tiktok').value = data.tiktok || "";
                    document.getElementById('edit-insta').value = data.insta || "";
                    document.getElementById('btn-tiktok').href = data.tiktok || "#";
                    document.getElementById('btn-insta').href = data.insta || "#";
                    // Validate visibility
                    document.getElementById('btn-tiktok').style.display = data.tiktok ? 'inline' : 'none';
                    document.getElementById('btn-insta').style.display = data.insta ? 'inline' : 'none';
                } else {
                    document.getElementById('creator-inputs').classList.add('hidden-section');
                    document.getElementById('social-buttons').classList.add('hidden-section');
                }

                document.getElementById('edit-bio').value = data.bio || "";
                document.getElementById('edit-photo').value = data.photoURL || "";
            }
        }

        function renderCardStatus(isPremium) {
            const cardBack = document.getElementById('card-back-style');
            if (isPremium) { cardBack.className = "card-face card-back status-premium"; document.getElementById('membership-type').innerText = "PREMIUM"; document.getElementById('membership-type').className = "text-2xl font-black uppercase text-[#F47521] drop-shadow-md"; document.getElementById('badge-icon').className = "fa-solid fa-crown text-5xl mb-2 text-yellow-400 animate-pulse"; } 
            else { cardBack.className = "card-face card-back status-basic"; document.getElementById('membership-type').innerText = "BÁSICO"; document.getElementById('membership-type').className = "text-2xl font-black uppercase text-gray-400"; document.getElementById('badge-icon').className = "fa-solid fa-user text-4xl mb-2 text-gray-500"; }
        }

        window.toggleEditMode = () => document.getElementById('editor-area').classList.toggle('hidden');
        
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 100000) { showNotification("Error", "Imagen muy pesada (Máx 100KB)", "error"); this.value = ""; return; }
                const reader = new FileReader();
                reader.onloadend = function() { document.getElementById('edit-photo').value = reader.result; }
                reader.readAsDataURL(file);
            }
        });

        window.guardarPerfil = async () => {
            if(!currentUserUid) return;
            const newBio = document.getElementById('edit-bio').value;
            let newPhoto = document.getElementById('edit-photo').value;
            
            // VALIDACIÓN SOCIAL (Anti-Tramposillo)
            const tiktokVal = document.getElementById('edit-tiktok').value;
            const instaVal = document.getElementById('edit-insta').value;

            if (tiktokVal && !tiktokVal.includes('tiktok.com')) { showCheatModal(); return; }
            if (instaVal && !instaVal.includes('instagram.com')) { showCheatModal(); return; }

            // Auto-restore photo
            if(!newPhoto || newPhoto.trim() === "") newPhoto = "https://via.placeholder.com/150";

            const updates = { bio: newBio, photoURL: newPhoto };
            if(!document.getElementById('creator-inputs').classList.contains('hidden-section')){
                updates.tiktok = tiktokVal;
                updates.insta = instaVal;
            }

            try {
                await updateDoc(doc(db, "users", currentUserUid), updates);
                await cargarDatosPerfil(auth.currentUser); // Recargar mis datos
                window.toggleEditMode();
                showNotification("Sistema", "Perfil actualizado correctamente.", "success");
            } catch(e) { showNotification("Error", e.message, "error"); }
        };

        window.confirmarBorrar = async () => {
            if(confirm("¿ESTÁS SEGURO? Esta acción es irreversible.")) {
                if(confirm("Última advertencia.")) {
                    try {
                        const user = auth.currentUser;
                        await deleteDoc(doc(db, "users", user.uid));
                        await deleteUser(user);
                        showNotification("Sistema", "Cuenta eliminada. Adiós.", "success");
                        setTimeout(() => window.location.reload(), 2000);
                    } catch(e) { showNotification("Error", "Requiere login reciente. Cierra y vuelve a entrar.", "error"); }
                }
            }
        };

        window.checkAdmin = async () => {
            const key = document.getElementById('admin-key').value;
            if (key === "#Lau3700#") {
                document.getElementById('admin-controls').classList.remove('hidden-section');
                await loadAllUsers();
            } else { document.getElementById('admin-controls').classList.add('hidden-section'); }
        };

        async function loadAllUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="2" class="text-center">Cargando...</td></tr>';
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                allUsersCache = [];
                querySnapshot.forEach((doc) => { allUsersCache.push({ id: doc.id, ...doc.data() }); });
                renderUserTable(allUsersCache);
            } catch (e) { tbody.innerHTML = '<tr><td colspan="2" class="text-red-500">Error</td></tr>'; }
        }

        window.filtrarUsuarios = () => {
            const term = document.getElementById('admin-search').value.toLowerCase();
            const filtered = allUsersCache.filter(u => (u.email && u.email.toLowerCase().includes(term)) || (u.username && u.username.toLowerCase().includes(term)));
            renderUserTable(filtered);
        };

        function renderUserTable(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            if (users.length === 0) { tbody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">Sin resultados</td></tr>'; return; }
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><div class="font-bold text-white">${u.username || 'Sin nombre'}</div><div class="text-gray-500 text-[10px]">${u.email || 'No Email'}</div></td><td class="font-mono text-xs text-gray-600">${u.id.substring(0,6)}...</td>`;
                tr.onclick = () => selectUserForAdmin(u.id, u.email);
                tbody.appendChild(tr);
            });
        }

        function selectUserForAdmin(uid, email) {
            selectedUserId = uid;
            const rows = document.querySelectorAll('.admin-table tr'); rows.forEach(r => r.classList.remove('selected'));
            const panel = document.getElementById('admin-actions-panel'); panel.classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('selected-user-email').innerText = email || uid;
        }

        // Acciones Admin
        window.adminSetPremium = async (status) => {
            if (!selectedUserId) return showNotification("Admin", "Selecciona usuario", "error");
            try { await updateDoc(doc(db, "users", selectedUserId), { isPremium: status }); showNotification("Admin", "Estado actualizado", "success"); if (selectedUserId === currentUserUid) cargarDatosPerfil(auth.currentUser); } catch(e) { showNotification("Error", e.message, "error"); }
        };
        window.adminAddTitle = async () => {
            if (!selectedUserId) return showNotification("Admin", "Selecciona usuario", "error");
            try { await updateDoc(doc(db, "users", selectedUserId), { titles: arrayUnion(document.getElementById('admin-title-select').value) }); showNotification("Admin", "Título asignado", "success"); if (selectedUserId === currentUserUid) cargarDatosPerfil(auth.currentUser); } catch(e) { showNotification("Error", e.message, "error"); }
        };
        window.adminSetFrame = async () => {
            if (!selectedUserId) return showNotification("Admin", "Selecciona usuario", "error");
            try { await updateDoc(doc(db, "users", selectedUserId), { frame: document.getElementById('admin-frame-select').value }); showNotification("Admin", "Marco aplicado", "success"); if (selectedUserId === currentUserUid) cargarDatosPerfil(auth.currentUser); } catch(e) { showNotification("Error", e.message, "error"); }
        };
        
        // ADMIN: VER DATOS (Carga en la vista principal para inspeccionar)
        window.adminViewData = async () => {
             if (!selectedUserId) return showNotification("Admin", "Selecciona usuario", "error");
             // Simulamos un objeto 'user' falso con solo el UID para que cargarDatosPerfil busque en DB
             await cargarDatosPerfil({ uid: selectedUserId });
             showNotification("Admin", "Datos cargados en vista previa.", "success");
        };

        // ADMIN: BORRAR USUARIO
        window.adminDeleteUser = async () => {
            if (!selectedUserId) return showNotification("Admin", "Selecciona usuario", "error");
            if (confirm(`¿Eliminar TODOS los datos de ${selectedUserId}?`)) {
                 try {
                     await deleteDoc(doc(db, "users", selectedUserId));
                     showNotification("Admin", "Usuario eliminado de DB", "success");
                     await loadAllUsers(); // Recargar tabla
                     // Limpiar vista
                     document.getElementById('admin-actions-panel').classList.add('opacity-50', 'pointer-events-none');
                 } catch(e) { showNotification("Error", e.message, "error"); }
            }
        };

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foro & Chat - ComicVerse</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --orange-cr: #F47521; 
            --dark-bg: #000000;
            --chat-bg: #0a0a0a;
            --magic-glow: 0 0 10px rgba(244, 117, 33, 0.5), 0 0 20px rgba(255, 100, 0, 0.3);
        }
        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--orange-cr); border-radius: 4px; }

        /* --- ESTILOS DE MARCOS --- */
        .avatar-container { position: relative; display: inline-block; padding: 4px; border-radius: 50%; box-sizing: border-box; }
        .frame-gold { background: linear-gradient(45deg, #FFD700, #FDB931); box-shadow: 0 0 10px #FFD700; animation: spin 4s linear infinite; }
        .frame-neon { background: linear-gradient(90deg, #00f2ff, #001eff); box-shadow: 0 0 10px #00f2ff; animation: pulse-blue 2s infinite; }
        .frame-fire { background: linear-gradient(0deg, #ff0000, #ffae00); box-shadow: 0 0 10px #ff4500; animation: shake 3s infinite; }
        .frame-glitch { border: 2px solid #00ff00; box-shadow: 2px 2px #ff00de; }
        .frame-angel-gold { border: 2px solid #FFD700; box-shadow: 0 0 10px #FFD700; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse-blue { 50% { box-shadow: 0 0 20px #00f2ff; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-1px); } 75% { transform: translateX(1px); } }
        
        /* --- Estilos Foro (PROFESIONAL V2) --- */
        .forum-card {
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 4px solid #333;
            border-radius: 4px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
            backdrop-filter: blur(5px);
            animation: fadeInUp 0.4s ease-out forwards;
        }
        
        /* --- ESTILO TOP 1 (GOLDEN THREAD) --- */
        .forum-card.gold-thread {
            border: 1px solid #FFD700;
            border-left: 4px solid #FFD700;
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.05), #0a0a0a);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);
        }
        .forum-card.gold-thread::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transform: skewX(-20deg);
            animation: shine 3s infinite; pointer-events: none;
        }
        @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        .forum-card:hover { transform: translateY(-3px); background: rgba(30, 30, 30, 0.8); }

        /* Categor√≠as (Chips Scrollables) */
        .category-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: none; /* Firefox */
        }
        .category-scroll::-webkit-scrollbar { display: none; } /* Chrome */

        .tag-pill {
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase; padding: 8px 16px;
            border-radius: 20px; background: #1a1a1a; color: #888; border: 1px solid #333;
            transition: 0.3s; cursor: pointer; white-space: nowrap; flex-shrink: 0;
        }
        .tag-pill:hover, .tag-pill.active { 
            background: #222; color: white; border-color: var(--orange-cr); 
            box-shadow: 0 0 10px rgba(244, 117, 33, 0.3); transform: scale(1.05);
        }
        /* Colores espec√≠ficos por categor√≠a */
        .tag-pill[data-cat="Teor√≠a"]:hover, .tag-pill[data-cat="Teor√≠a"].active { border-color: #3b82f6; color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .tag-pill[data-cat="Spoilers"]:hover, .tag-pill[data-cat="Spoilers"].active { border-color: #ef4444; color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        .tag-pill[data-cat="Noticias"]:hover, .tag-pill[data-cat="Noticias"].active { border-color: #eab308; color: #eab308; box-shadow: 0 0 10px rgba(234, 179, 8, 0.3); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Estilos Chat Global --- */
        .chat-container {
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            border: 1px solid #333; border-radius: 16px;
            height: 600px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative;
        }
        .chat-header-bar {
            background: linear-gradient(90deg, #F47521, #d65a00); padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column-reverse; gap: 15px; }
        
        .message { display: flex; gap: 12px; max-width: 85%; animation: fadeIn 0.3s; align-items: flex-end; }
        .message.self { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar-box { flex-shrink: 0; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; }
        .avatar-sm { width: 36px; height: 36px; object-fit: cover; border-radius: 50%; border: 1px solid #444; display: block; }
        
        .message-content {
            background: #222; padding: 10px 15px; border-radius: 18px; border-bottom-left-radius: 2px;
            font-size: 0.95rem; color: #ddd; word-break: break-word; border: 1px solid #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .message.self .message-content {
            background: linear-gradient(135deg, #F47521, #ff9100); color: black; font-weight: 600;
            border-radius: 18px; border-bottom-right-radius: 2px; border: none;
            box-shadow: 0 0 15px rgba(244, 117, 33, 0.3);
        }
        .message-meta { font-size: 0.7rem; color: #666; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .message.self .message-meta { justify-content: flex-end; color: #888; }

        /* --- Estilos Ranking Foro --- */
        .ranking-card { background: #111; border-radius: 6px; padding: 14px; margin-bottom: 8px; border: 1px solid #222; display: flex; align-items: center; gap: 10px; transition: 0.2s; position: relative; overflow: hidden; }
        .ranking-card:hover { border-color: var(--orange-cr); background: #161616; transform: translateX(5px); }
        .ranking-card.gold::after { content:''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: #FFD700; }
        
        /* --- Estilos IA Chat --- */
        .ai-message { max-width: 90%; margin-bottom: 15px; display: flex; gap: 10px; }
        .ai-message.bot { align-items: flex-start; }
        .ai-message.user { align-items: flex-end; flex-direction: row-reverse; align-self: flex-end; }
        .ai-bubble { padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; }
        .ai-bubble.bot { background: #1a1a1a; border: 1px solid #333; color: #ddd; border-top-left-radius: 2px; }
        .ai-bubble.user { background: #F47521; color: black; font-weight: 600; border-top-right-radius: 2px; }
        .ai-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #F47521; object-fit: cover; }

        /* --- Modales --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 60; }
        .hidden-section { display: none !important; }
        .input-dark { background: #0a0a0a; border: 1px solid #333; color: white; padding: 12px; width: 100%; border-radius: 4px; outline: none; transition: 0.3s; }
        .input-dark:focus { border-color: var(--orange-cr); box-shadow: 0 0 15px rgba(244,117,33,0.2); background: #111; }

        .btn-delete { color: #ef4444; opacity: 0.5; transition: 0.2s; }
        .btn-delete:hover { opacity: 1; transform: scale(1.2); }
        
        /* Paginaci√≥n */
        .pagination-btn {
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 8px 16px; border-radius: 6px;
            font-size: 0.8rem; font-weight: bold; uppercase; transition: 0.2s; cursor: pointer;
        }
        .pagination-btn:hover:not(:disabled) { border-color: var(--orange-cr); color: var(--orange-cr); }
        .pagination-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    </style>
</head>
<body class="pb-20">

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        
        <!-- HEADER LOGIN STATUS -->
        <div id="login-status-bar" class="flex justify-end mb-4">
            <button onclick="parent.cargarPagina('Usuario.html', null)" class="text-xs text-gray-500 hover:text-[#F47521] uppercase font-bold flex items-center gap-2 group">
                <div class="w-2 h-2 rounded-full bg-red-500 group-hover:bg-green-500 transition"></div>
                <span id="current-username">Invitado (Iniciar Sesi√≥n)</span>
            </button>
        </div>

        <!-- ======================= -->
        <!-- SECCI√ìN 1: FORO COMPLETO Y RANKING -->
        <!-- ======================= -->
        <div class="mb-20 grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <!-- COLUMNA PRINCIPAL FORO -->
            <div class="lg:col-span-3">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-4 border-b border-gray-800 pb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-2 h-12 bg-gradient-to-b from-[#F47521] to-yellow-500 shadow-[0_0_20px_#F47521]"></div>
                        <div>
                            <h1 class="text-4xl md:text-5xl font-black italic uppercase tracking-tighter text-white drop-shadow-xl">
                                Foro <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#F47521] to-yellow-400">Global</span>
                            </h1>
                            <p class="text-gray-500 text-sm mt-1">Debate, comparte y conecta.</p>
                        </div>
                    </div>
                    <button onclick="openThreadModal()" class="bg-gradient-to-r from-[#F47521] to-red-600 hover:from-white hover:to-gray-200 hover:text-black text-white font-black uppercase py-3 px-8 rounded-lg text-sm transition-all shadow-[0_0_20px_rgba(244,117,33,0.4)] transform hover:scale-105 flex items-center gap-2 border border-white/10 group">
                        <i class="fa-solid fa-pen-nib group-hover:animate-bounce"></i> Crear Discusi√≥n
                    </button>
                </div>
                
                <!-- NUEVA BARRA DE CATEGOR√çAS (SCROLLABLE) -->
                <div class="mb-6 relative">
                    <div class="category-scroll" id="forum-filters">
                        <button class="tag-pill active" onclick="filtrarCategoria('Todo', this)">Todo</button>
                        <button class="tag-pill" data-cat="Teor√≠a" onclick="filtrarCategoria('Teor√≠a', this)">Teor√≠a</button>
                        <button class="tag-pill" data-cat="Spoilers" onclick="filtrarCategoria('Spoilers', this)">Spoilers</button>
                        <button class="tag-pill" data-cat="Noticias" onclick="filtrarCategoria('Noticias', this)">Noticias</button>
                        <button class="tag-pill" onclick="filtrarCategoria('FanArt', this)">FanArt</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Debate', this)">Debate</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Rese√±a', this)">Rese√±a</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Ayuda', this)">Ayuda</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Isekai', this)">Isekai</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Shonen', this)">Shonen</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Seinen', this)">Seinen</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Romance', this)">Romance</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Terror', this)">Terror</button>
                        <button class="tag-pill" onclick="filtrarCategoria('Off-Topic', this)">Off-Topic</button>
                    </div>
                    <div class="absolute right-0 top-0 h-full w-10 bg-gradient-to-l from-[#000] to-transparent pointer-events-none"></div>
                </div>

                <!-- BUSQUEDA -->
                <div class="flex flex-col md:flex-row gap-4 mb-6 bg-[#0f0f0f] p-3 rounded-lg border border-white/5 shadow-lg items-center">
                    <div class="relative flex-1 w-full">
                        <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-500"></i>
                        <input type="text" id="search-threads" placeholder="Buscar hilos..." class="input-dark pl-10 bg-[#050505] border-[#222] focus:bg-[#0a0a0a]" onkeyup="filtrarHilos()">
                    </div>
                    <div class="text-xs text-gray-500 font-mono uppercase hidden md:block">
                        <span id="thread-count">0</span> Hilos activos
                    </div>
                </div>
                
                <!-- LISTA DE HILOS (CON PAGINACI√ìN) -->
                <div id="threads-container" class="grid grid-cols-1 gap-4 min-h-[400px] content-start">
                    <div class="text-center text-gray-600 py-20 flex flex-col items-center">
                        <i class="fa-solid fa-spinner fa-spin text-4xl mb-4 text-[#F47521]"></i>
                        <span class="uppercase tracking-widest text-xs">Cargando datos del servidor...</span>
                    </div>
                </div>
                
                <!-- CONTROLES PAGINACI√ìN -->
                <div id="pagination-controls" class="flex justify-center gap-4 mt-8 hidden-section">
                    <button id="prev-page-btn" class="pagination-btn" onclick="changePage(-1)"><i class="fa-solid fa-chevron-left"></i> Anterior</button>
                    <span id="page-indicator" class="text-sm font-bold text-gray-500 flex items-center">P√°gina 1</span>
                    <button id="next-page-btn" class="pagination-btn" onclick="changePage(1)">Siguiente <i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- SIDEBAR RANKING -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Top Hilos -->
                <div class="bg-[#0a0a0a] border border-gray-800 rounded-xl p-6 shadow-2xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#F47521] to-transparent"></div>
                    <h3 class="text-white font-black uppercase mb-6 flex items-center gap-2 text-sm tracking-widest">
                        <span class="bg-[#F47521] text-black w-6 h-6 flex items-center justify-center rounded text-xs"><i class="fa-solid fa-fire"></i></span>
                        Tendencias
                    </h3>
                    <div id="ranking-threads" class="space-y-3 text-sm">
                        <p class="text-gray-600 text-xs italic">Analizando tr√°fico...</p>
                    </div>
                </div>

                <!-- Top Categor√≠as -->
                <div class="bg-[#0a0a0a] border border-gray-800 rounded-xl p-6 shadow-2xl">
                    <h3 class="text-white font-black uppercase mb-6 flex items-center gap-2 text-sm tracking-widest">
                         <span class="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded text-xs"><i class="fa-solid fa-layer-group"></i></span>
                         Populares
                    </h3>
                    <div id="ranking-categories" class="flex flex-wrap gap-2">
                        <!-- JS Llenar√° esto -->
                    </div>
                </div>
            </div>

        </div>

        <!-- ======================= -->
        <!-- SECCI√ìN 2: CHAT GLOBAL -->
        <!-- ======================= -->
        <div class="border-t border-gray-800 pt-16 mb-20">
            <div class="chat-container">
                <div class="chat-header-bar">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-comments text-black text-2xl"></i>
                        <h2 class="text-2xl font-black italic uppercase tracking-tighter text-black">
                            Chat <span class="text-white drop-shadow-md">En Vivo</span>
                        </h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-black/20 px-3 py-1 rounded-full border border-black/10">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <span class="text-xs font-bold text-black uppercase">Limpieza en 1h</span>
                        </div>
                        <button onclick="requestAdminAction(openClearChatModal)" class="bg-red-600 hover:bg-white hover:text-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg border-2 border-red-800" title="Limpiar todo (Admin)">
                            <i class="fa-solid fa-broom"></i>
                        </button>
                    </div>
                </div>

                <div id="chat-messages" class="chat-messages custom-scroll">
                    <div class="text-center text-gray-500 mt-10">Conectando...</div>
                </div>
                
                <form id="chat-form" class="p-4 bg-black border-t border-[#F47521]/30 flex gap-3 relative z-20">
                    <div class="relative flex-1">
                        <input type="text" id="chat-input" class="w-full bg-[#1a1a1a] border border-[#333] text-white p-3 pl-4 rounded-full outline-none focus:border-[#F47521] focus:ring-1 focus:ring-[#F47521] transition" placeholder="Escribe algo a la comunidad..." maxlength="200" autocomplete="off">
                    </div>
                    <button type="submit" id="chat-btn" class="bg-[#F47521] hover:bg-white text-black font-bold p-3 w-12 h-12 rounded-full transition shadow-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- ======================= -->
        <!-- SECCI√ìN 3: IA COMICVERSE -->
        <!-- ======================= -->
        <div class="mb-20 border-t border-gray-800 pt-12">
            <!-- T√≠tulo IA Personalizado (AHORA NARANJA) -->
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-8 border-b border-gray-800 pb-6">
                <div class="flex items-center gap-4">
                    <div class="w-2 h-12 bg-gradient-to-b from-[#F47521] to-yellow-500 shadow-[0_0_20px_#F47521]"></div>
                    <div>
                        <h1 class="text-4xl md:text-5xl font-black italic uppercase tracking-tighter text-white drop-shadow-xl">
                            IA <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#F47521] to-yellow-400">ComicVerse</span>
                        </h1>
                        <p class="text-gray-500 text-sm mt-1">Asistente Otaku Inteligente.</p>
                    </div>
                </div>
                <button onclick="requestAiSettings()" class="bg-gray-800 hover:bg-[#F47521] hover:text-black text-white p-3 rounded-lg transition border border-white/10 font-bold text-xs uppercase tracking-widest flex items-center gap-2 group">
                    <i class="fa-solid fa-gear group-hover:spin"></i> Configuraci√≥n
                </button>
            </div>
            
            <div class="bg-[#111] border border-[#F47521]/30 rounded-xl overflow-hidden shadow-2xl flex flex-col h-[600px] relative">
                <!-- Header IA -->
                <div class="bg-[#F47521]/10 p-4 border-b border-[#F47521]/20 flex items-center gap-4">
                    <img id="ai-avatar-display" src="https://image.pollinations.ai/prompt/anime%20cyborg%20girl%20face%20close%20up%20avatar%20flat%20vector?width=100&height=100&nologo=true" class="w-12 h-12 rounded-full border-2 border-[#F47521] object-cover">
                    <div>
                        <h3 class="font-bold text-white text-lg">ComicBot</h3>
                        <p class="text-xs text-orange-300">Creado por ComicsCadaUnDia ‚Ä¢ Asistente Otaku</p>
                    </div>
                </div>

                <!-- Chat Area IA -->
                <div id="ai-chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
                    <!-- Mensaje Bienvenida -->
                    <div class="ai-message bot">
                        <img src="https://image.pollinations.ai/prompt/anime%20cyborg%20girl%20face%20close%20up%20avatar%20flat%20vector?width=100&height=100&nologo=true" class="ai-avatar bg-black">
                        <div class="ai-bubble bot">
                            ¬°Hola! Soy ComicBot, tu asistente personal. ü§ñ‚ú®<br><br>
                            Puedo ayudarte a entender la web, recomendar c√≥mics o simplemente hablar de anime.<br>
                            üé® <b>Escribe "Crea esta imagen: [descripci√≥n]"</b> para que genere arte para ti.
                        </div>
                    </div>
                </div>

                <!-- Input IA -->
                <form id="ai-form" class="p-4 bg-black border-t border-[#F47521]/30 flex gap-3">
                    <input type="text" id="ai-input" class="input-dark flex-1 !border-orange-900 focus:!border-[#F47521] focus:!shadow-orange-500/20" placeholder="Preg√∫ntame algo o pide una imagen..." autocomplete="off">
                    <button type="submit" class="bg-[#F47521] hover:bg-white text-black font-bold p-3 rounded-lg transition">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </button>
                </form>
            </div>
        </div>

    </div>

    <!-- --- MODALES --- -->

    <!-- MODAL PERSONALIZAR IA -->
    <div id="ai-settings-modal" class="hidden-section modal-overlay">
        <div class="bg-[#111] border border-blue-500 w-full max-w-md p-6 rounded-xl shadow-[0_0_50px_rgba(59,130,246,0.3)] animate-[fadeIn_0.3s_ease-out]">
            <h3 class="text-xl font-bold text-white mb-4 uppercase"><i class="fa-solid fa-robot text-blue-500"></i> Personalizar IA</h3>
            <label class="block text-xs text-gray-500 uppercase font-bold mb-1">Foto de la IA (URL)</label>
            <input type="text" id="ai-avatar-url" placeholder="https://..." class="input-dark mb-2 text-xs">
            <label class="block text-xs text-gray-500 uppercase font-bold mb-1">O subir imagen</label>
            <input type="file" id="ai-file-upload" accept="image/*" class="text-xs text-gray-400 mb-4">
            <label class="block text-xs text-gray-500 uppercase font-bold mb-1">System Prompt (Personalidad)</label>
            <textarea id="ai-system-prompt" class="input-dark h-32 text-xs mb-4" placeholder="Instrucciones para la IA..."></textarea>
            <div class="flex gap-2"><button onclick="saveAiSettings()" class="flex-1 bg-[#F47521] hover:bg-white hover:text-black text-black font-bold py-2 rounded">Guardar</button><button onclick="closeAiSettings()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 rounded">Cancelar</button></div>
        </div>
    </div>

    <!-- MODAL CREAR HILO -->
    <div id="thread-modal" class="hidden-section modal-overlay">
        <div class="bg-[#111] border-2 border-[#F47521] w-full max-w-2xl p-8 rounded-2xl relative shadow-[0_0_60px_rgba(244,117,33,0.3)] animate-[fadeIn_0.3s_ease-out]">
            <button onclick="closeThreadModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-3xl font-black text-white uppercase mb-6 flex items-center gap-3"><i class="fa-solid fa-pen-to-square text-[#F47521]"></i> Nuevo Hilo</h3>
            <form id="create-thread-form" class="space-y-5">
                <div><label class="block text-xs text-[#F47521] uppercase font-bold mb-2">T√≠tulo</label><input type="text" id="thread-title" class="input-dark text-lg font-bold" required maxlength="80"></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Categor√≠a</label><select id="thread-tag" class="input-dark cursor-pointer text-gray-300">
                    <option value="General">General</option><option value="Teor√≠a">Teor√≠a</option><option value="Spoilers">Spoilers</option><option value="FanArt">FanArt</option><option value="Noticias">Noticias</option><option value="Ayuda">Ayuda</option><option value="Rese√±a">Rese√±a</option><option value="Debate">Debate</option><option value="Isekai">Isekai</option><option value="Shonen">Shonen</option><option value="Seinen">Seinen</option><option value="Romance">Romance</option><option value="Terror">Terror</option><option value="Comedia">Comedia</option><option value="Yuri/Yaoi">Yuri/Yaoi</option><option value="Cosplay">Cosplay</option><option value="Tutorial">Tutorial</option><option value="Off-Topic">Off-Topic</option>
                </select></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Contenido</label><textarea id="thread-content" class="input-dark h-40 resize-none" required></textarea></div>
                <button type="submit" class="w-full bg-gradient-to-r from-[#F47521] to-red-600 text-white font-black uppercase py-4 rounded-lg">Publicar</button>
            </form>
        </div>
    </div>
    <!-- MODAL BORRAR -->
    <div id="delete-modal" class="hidden-section modal-overlay"><div class="modal-box border-red-600 shadow-red-900/50 text-center"><i class="fa-solid fa-trash-can text-5xl text-red-600 mb-4 animate-bounce"></i><h3 class="text-2xl font-black text-white uppercase mb-2">Zona de Peligro</h3><p class="text-gray-400 mb-6 text-sm">Ingresa clave admin.</p><input type="password" id="delete-key" class="input-dark text-center text-red-500 font-bold tracking-[0.5em] text-xl mb-6 border-red-900 focus:border-red-500" placeholder="CLAVE"><div class="flex gap-3"><button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded uppercase">Eliminar</button><button onclick="closeDeleteModal()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded uppercase">Cancelar</button></div></div></div>
    <!-- MODAL VACIAR CHAT -->
    <div id="clear-chat-modal" class="hidden-section modal-overlay"><div class="modal-box border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.5)] text-center bg-[#110000]"><i class="fa-solid fa-biohazard text-5xl text-red-600 mb-4 animate-pulse"></i><h3 class="text-2xl font-black text-white uppercase mb-2">Limpieza Total</h3><p class="text-red-300 mb-6 text-sm font-bold">BORRAR√Å TODO EL CHAT.</p><input type="password" id="clear-chat-key" class="input-dark text-center text-red-500 font-bold tracking-[0.5em] text-xl mb-6 border-red-900 focus:border-red-500 bg-black" placeholder="CLAVE MAESTRA"><div class="flex gap-3"><button onclick="confirmClearChat()" class="flex-1 bg-red-700 hover:bg-red-600 text-white font-black py-3 rounded uppercase border border-red-500">EJECUTAR</button><button onclick="closeClearChatModal()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded uppercase">ABORTAR</button></div></div></div>
    <!-- MODAL VER HILO (MEJORADO PARA M√ìVIL) -->
    <div id="view-thread-modal" class="hidden-section modal-overlay p-0 md:p-4">
        <div class="bg-[#111] border border-gray-700 w-full md:max-w-4xl h-[100dvh] md:h-[90vh] rounded-none md:rounded-xl flex flex-col relative shadow-2xl animate-[fadeIn_0.3s_ease-out]">
            <!-- Header (fijo) -->
            <div class="p-4 md:p-6 border-b border-gray-800 bg-[#151515] rounded-t-none md:rounded-t-xl flex justify-between items-start flex-shrink-0">
                <div>
                    <div id="view-thread-tags" class="mb-2"></div>
                    <h2 id="view-thread-title" class="text-xl md:text-3xl font-bold text-white mb-2 leading-tight"></h2>
                    <div class="flex items-center gap-3 text-xs text-gray-500">
                        <span id="view-thread-author" class="text-[#F47521] font-bold"></span>
                        <span id="view-thread-date"></span>
                    </div>
                </div>
                <button onclick="closeViewModal()" class="text-gray-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <!-- Contenido Principal (scroll) -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scroll relative">
                <p id="view-thread-content" class="text-gray-300 text-base md:text-lg leading-relaxed mb-8 whitespace-pre-wrap"></p>
                <div class="border-t border-gray-800 pt-6">
                    <h4 class="text-white font-bold uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-comments text-[#F47521]"></i> Comentarios</h4>
                    <div id="comments-list" class="space-y-4"></div>
                </div>
            </div>
            
            <!-- Footer (fijo) -->
            <form id="comment-form" class="p-4 bg-black border-t border-gray-800 flex gap-3 rounded-b-none md:rounded-b-xl flex-shrink-0 pb-6 md:pb-4">
                <input type="text" id="comment-input" class="input-dark flex-1" placeholder="Escribe un comentario..." required>
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 rounded-lg transition">Enviar</button>
            </form>
        </div>
    </div>

    <!-- LOGICA FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, deleteDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, increment, getDocs, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf9ATqgErKQKpzKpFXsUu4BHmFcNSLzOE",
            authDomain: "comic-a54bf.firebaseapp.com",
            projectId: "comic-a54bf",
            storageBucket: "comic-a54bf.firebasestorage.app",
            messagingSenderId: "653412030846",
            appId: "1:653412030846:web:86f30b301d3c8c41e1fb2f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let userData = { username: "Invitado", avatar: "https://via.placeholder.com/150", frame: "" };

        // --- DEFAULTS DE LA IA ---
        let aiSystemPrompt = "Eres ComicBot, una IA creada por ComicsCadaUnDia para el sitio ComicVerse. Eres una experta Otaku, amigable y entusiasta. Tu misi√≥n es ayudar a los usuarios a entender la web: INICIO (Novedades), ORIGINALES (C√≥mics del creador), FANS (C√≥mics de la comunidad), ADELANTOS (Spoilers), QUIZS (Juegos), FORO (Comunidad), PR√ìXIMAMENTE (Futuro). Tambi√©n sabes mucho de anime y manga. Si te piden im√°genes, diles que usen el comando 'Crea esta imagen'.";
        let aiAvatar = "https://image.pollinations.ai/prompt/anime%20cyborg%20girl%20face%20close%20up%20avatar%20flat%20vector?width=100&height=100&nologo=true";

        if(localStorage.getItem('ai_prompt')) aiSystemPrompt = localStorage.getItem('ai_prompt');
        if(localStorage.getItem('ai_avatar')) {
            aiAvatar = localStorage.getItem('ai_avatar');
            document.querySelectorAll('#ai-avatar-display').forEach(img => img.src = aiAvatar);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userData.username = data.username || user.displayName;
                    userData.avatar = data.photoURL || user.photoURL || "https://via.placeholder.com/40";
                    userData.frame = data.frame || ""; 
                    document.getElementById('current-username').innerText = userData.username;
                }
            } else {
                currentUser = null;
                document.getElementById('current-username').innerText = "Invitado (Iniciar Sesi√≥n)";
            }
        });

        window.alertRequiredLogin = () => {
            if(confirm("üîí Debes iniciar sesi√≥n.\n\n¬øIr al Login?")) {
                if(window.parent && window.parent.cargarPagina) window.parent.cargarPagina('Usuario.html', null);
                else window.location.href = 'Usuario.html';
            }
        };

        // --- CHAT GLOBAL ---
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-messages');
        const chatInputBtn = document.getElementById('chat-btn');
        let chatCooldown = false;

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return alertRequiredLogin();
            if (chatCooldown) return;

            const text = chatInput.value.trim();
            if (!text) return;

            // Start Cooldown
            chatCooldown = true;
            chatInputBtn.disabled = true;
            chatInputBtn.classList.add('opacity-50', 'cursor-not-allowed');
            let timeLeft = 5;
            chatInputBtn.innerHTML = timeLeft;
            const timer = setInterval(() => {
                timeLeft--; chatInputBtn.innerHTML = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer); chatCooldown = false; chatInputBtn.disabled = false;
                    chatInputBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    chatInputBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
                }
            }, 1000);

            try {
                await addDoc(collection(db, "global_chat"), {
                    text, uid: currentUser.uid, username: userData.username, avatar: userData.avatar, frame: userData.frame, createdAt: serverTimestamp()
                });
                chatInput.value = "";
            } catch (err) { console.error(err); }
        });

        const qChat = query(collection(db, "global_chat"), orderBy("createdAt", "desc"), limit(60));
        onSnapshot(qChat, (snapshot) => {
            chatContainer.innerHTML = "";
            const messages = [];
            snapshot.forEach(doc => {
                const msg = doc.data(); msg.id = doc.id;
                if (msg.createdAt) { if (msg.createdAt.toDate() > new Date(Date.now() - 3600000)) messages.push(msg); } 
                else messages.push(msg);
            });
            if (messages.length === 0) chatContainer.innerHTML = '<div class="text-center text-gray-600 mt-10">El chat est√° limpio.</div>';
            
            messages.forEach((msg) => {
                const isSelf = currentUser && msg.uid === currentUser.uid;
                const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                const frameClass = msg.frame || '';
                const avatarSrc = (msg.avatar && msg.avatar.length > 10) ? msg.avatar : "https://via.placeholder.com/40";
                const deleteBtn = `<button onclick="requestDelete('${msg.id}', 'global_chat')" class="btn-delete ml-2 text-[10px]"><i class="fa-solid fa-trash"></i></button>`;

                const html = `<div class="message ${isSelf ? 'self' : ''}"><div class="message-avatar-box"><div class="avatar-container ${frameClass}" style="padding:2px;"><img src="${avatarSrc}" class="avatar-sm"></div></div><div class="flex flex-col ${isSelf ? 'items-end' : 'items-start'} max-w-full"><div class="message-meta"><span class="font-bold ${isSelf ? 'text-[#F47521]' : 'text-gray-400'}">${msg.username}</span><span class="opacity-50">${time}</span>${deleteBtn}</div><div class="message-content">${msg.text}</div></div></div>`;
                chatContainer.insertAdjacentHTML('beforeend', html);
            });
        });

        // --- IA COMICVERSE ---
        const aiForm = document.getElementById('ai-form');
        const aiInput = document.getElementById('ai-input');
        const aiContainer = document.getElementById('ai-chat-messages');

        window.requestAdminAction = (action) => {
            const pass = prompt("üîê ADMIN ACCESS REQUIRED\nIngrese Clave:");
            if(pass === "#Lau3700#") action();
            else if(pass !== null) alert("Clave Incorrecta.");
        };

        window.requestAiSettings = () => {
            requestAdminAction(openAiSettings);
        };

        window.openAiSettings = () => { document.getElementById('ai-settings-modal').classList.remove('hidden-section'); document.getElementById('ai-system-prompt').value = aiSystemPrompt; document.getElementById('ai-avatar-url').value = aiAvatar; };
        window.closeAiSettings = () => document.getElementById('ai-settings-modal').classList.add('hidden-section');
        window.saveAiSettings = () => { const promptVal = document.getElementById('ai-system-prompt').value; let avatarVal = document.getElementById('ai-avatar-url').value; if(promptVal) { aiSystemPrompt = promptVal; localStorage.setItem('ai_prompt', promptVal); } if(avatarVal) { aiAvatar = avatarVal; localStorage.setItem('ai_avatar', avatarVal); document.getElementById('ai-avatar-display').src = aiAvatar; } closeAiSettings(); };
        document.getElementById('ai-file-upload').addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = function() { document.getElementById('ai-avatar-url').value = reader.result; }; reader.readAsDataURL(file); } });

        aiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = aiInput.value.trim();
            if(!text) return;
            aiContainer.insertAdjacentHTML('beforeend', `<div class="ai-message user"><div class="ai-bubble user">${text}</div></div>`);
            aiInput.value = "";
            aiContainer.scrollTop = aiContainer.scrollHeight;
            const loadingId = Date.now();
            aiContainer.insertAdjacentHTML('beforeend', `<div class="ai-message bot" id="${loadingId}"><img src="${aiAvatar}" class="ai-avatar bg-black"><div class="ai-bubble bot">Pensando... <i class="fa-solid fa-spinner fa-spin"></i></div></div>`);
            aiContainer.scrollTop = aiContainer.scrollHeight;

            try {
                const botMsgDiv = document.getElementById(loadingId);
                let response = "";
                const lowerText = text.toLowerCase();
                if (lowerText.startsWith("crea esta imagen") || lowerText.startsWith("dibuja")) {
                    const prompt = text.replace(/crea esta imagen|dibuja/gi, "").trim();
                    const encodedPrompt = encodeURIComponent(prompt + " anime style masterpiece");
                    response = `¬°Aqu√≠ tienes! üé®<br><br><img src="https://image.pollinations.ai/prompt/${encodedPrompt}" style="border-radius:8px; width:100%; border:1px solid #333;">`;
                } else {
                    const instruction = `${aiSystemPrompt}\nUser: ${text}\nAI:`;
                    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(instruction)}`);
                    response = res.ok ? await res.text() : "Error de conexi√≥n.";
                }
                botMsgDiv.querySelector('.ai-bubble').innerHTML = response;
                aiContainer.scrollTop = aiContainer.scrollHeight;
            } catch (err) { console.error(err); document.getElementById(loadingId).remove(); }
        });

        // --- FORO: LISTADO & PAGINACI√ìN ---
        const threadsContainer = document.getElementById('threads-container');
        const rankingThreadsEl = document.getElementById('ranking-threads');
        const rankingCatsEl = document.getElementById('ranking-categories');
        const qThreads = query(collection(db, "forum_threads"), orderBy("createdAt", "desc"), limit(100)); // Get plenty for local pagination
        
        let allThreads = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let topThreadId = null;

        onSnapshot(qThreads, (snapshot) => {
            allThreads = [];
            const catCounts = {};
            let maxLikes = -1;

            snapshot.forEach(doc => { 
                const d = doc.data(); d.id = doc.id; 
                allThreads.push(d); 
                catCounts[d.tag] = (catCounts[d.tag] || 0) + 1;
                // Detectar Top Global 1
                if((d.likes || 0) > maxLikes) {
                    maxLikes = d.likes;
                    topThreadId = d.id;
                }
            });

            // Si hay empate o 0 likes, el primero es top (o ninguno, seg√∫n prefieras. Aqu√≠ el primero)
            if(allThreads.length > 0 && maxLikes === 0) topThreadId = allThreads[0].id;

            renderThreads();
            updateRankings(allThreads, catCounts);
        });

        function updateRankings(threads, catCounts) {
            const sortedThreads = [...threads].sort((a,b) => (b.likes || 0) - (a.likes || 0)).slice(0, 5);
            if(rankingThreadsEl) {
                rankingThreadsEl.innerHTML = "";
                sortedThreads.forEach((t, index) => {
                    let medal = index === 0 ? "ü•á" : (index === 1 ? "ü•à" : (index === 2 ? "ü•â" : ""));
                    let color = index === 0 ? "text-yellow-400" : (index === 1 ? "text-gray-300" : "text-gray-400");
                    rankingThreadsEl.innerHTML += `<div class="flex items-center justify-between border-b border-white/5 pb-2 mb-2 cursor-pointer hover:bg-white/5 p-2 rounded" onclick="openViewModal('${t.id}')"><div class="truncate flex-1 pr-2 ${color} font-bold text-xs">${medal} ${index+1}. ${t.title}</div><div class="text-xs text-red-500 font-mono"><i class="fa-solid fa-heart"></i> ${t.likes || 0}</div></div>`;
                });
            }
            if(rankingCatsEl) {
                const sortedCats = Object.entries(catCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
                rankingCatsEl.innerHTML = "";
                sortedCats.forEach(([cat, count]) => {
                    rankingCatsEl.innerHTML += `<div class="text-[10px] bg-[#222] border border-blue-900 text-blue-400 px-2 py-1 rounded flex items-center gap-1">${cat} <span class="bg-blue-900 text-white px-1 rounded-full">${count}</span></div>`;
                });
            }
        }

        window.changePage = (direction) => {
            const totalPages = Math.ceil(allThreads.length / itemsPerPage);
            if (direction === 1 && currentPage < totalPages) currentPage++;
            if (direction === -1 && currentPage > 1) currentPage--;
            renderThreads();
        };

        window.renderThreads = (threadsToRender = allThreads) => {
            if(!threadsContainer) return;
            threadsContainer.innerHTML = "";
            
            const total = threadsToRender.length;
            if(total === 0) { 
                threadsContainer.innerHTML = '<div class="text-center text-gray-600">No hay discusiones.</div>'; 
                document.getElementById('pagination-controls').classList.add('hidden-section');
                return; 
            }

            // Client side pagination logic
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageThreads = threadsToRender.slice(start, end);

            pageThreads.forEach((data, index) => {
                const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'Reciente';
                let tagColor = "border-l-gray-500";
                if(data.tag === 'Noticias') tagColor = "border-l-yellow-500";
                else if(data.tag === 'Teor√≠a') tagColor = "border-l-blue-500";
                else if(data.tag === 'Spoilers') tagColor = "border-l-red-500";
                // ... m√°s colores si quieres ...

                const frameClass = data.frame || '';
                const avatarSrc = (data.avatar && data.avatar.length > 10) ? data.avatar : "https://via.placeholder.com/40";
                
                // IS GOLDEN THREAD?
                const isGold = data.id === topThreadId ? 'gold-thread' : '';
                const goldBadge = isGold ? '<span class="absolute top-0 right-0 bg-[#FFD700] text-black text-[9px] font-bold px-2 rounded-bl-lg">TOP #1</span>' : '';

                const html = `
                    <div class="forum-card cursor-pointer ${tagColor} ${isGold}" onclick="openViewModal('${data.id}')">
                        ${goldBadge}
                        <div class="flex justify-between items-start mb-3 relative z-10">
                            <div class="flex items-center gap-3">
                                <div class="avatar-container ${frameClass}" style="padding:2px;"><img src="${avatarSrc}" class="w-10 h-10 rounded-full border border-gray-600 object-cover"></div>
                                <div><h3 class="text-lg font-bold text-white leading-tight hover:text-[#F47521] transition">${data.title}</h3><p class="text-xs text-gray-500">por <span class="text-[#F47521]">${data.author}</span> ‚Ä¢ ${date}</p></div>
                            </div>
                            <button onclick="event.stopPropagation(); requestDelete('${data.id}', 'forum_threads')" class="btn-delete p-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <p class="text-gray-300 text-sm mb-4 pl-14 line-clamp-2 relative z-10">${data.content}</p>
                        <div class="pl-14 flex items-center gap-4 relative z-10">
                            <span class="tag-badge border border-white/10 text-white bg-[#222]">${data.tag}</span>
                            <div class="flex items-center gap-1 text-xs text-gray-500"><i class="fa-solid fa-heart text-red-500"></i> ${data.likes || 0}</div>
                            <div class="flex items-center gap-1 text-xs text-gray-500"><i class="fa-solid fa-comment text-blue-500"></i> ${data.commentCount || 0}</div>
                        </div>
                    </div>
                `;
                threadsContainer.insertAdjacentHTML('beforeend', html);
            });

            // Update Pagination UI
            const pageControls = document.getElementById('pagination-controls');
            if (total > itemsPerPage) {
                pageControls.classList.remove('hidden-section');
                document.getElementById('page-indicator').innerText = `P√°gina ${currentPage} de ${Math.ceil(total/itemsPerPage)}`;
                document.getElementById('prev-page-btn').disabled = currentPage === 1;
                document.getElementById('next-page-btn').disabled = currentPage === Math.ceil(total/itemsPerPage);
            } else {
                pageControls.classList.add('hidden-section');
            }
        };
        
        window.filtrarCategoria = (cat, btn) => {
            document.querySelectorAll('.tag-pill').forEach(b => b.classList.remove('active', 'bg-[#222]', 'text-white'));
            if(btn) btn.classList.add('active');
            currentPage = 1; // Reset page on filter
            if (cat === 'Todo') renderThreads(allThreads); 
            else renderThreads(allThreads.filter(t => t.tag === cat));
        };
        window.filtrarHilos = () => {
            const term = document.getElementById('search-threads').value.toLowerCase();
            currentPage = 1;
            renderThreads(allThreads.filter(t => t.title.toLowerCase().includes(term) || t.content.toLowerCase().includes(term)));
        };

        // MODALS & ACTIONS
        const threadModal = document.getElementById('thread-modal');
        const threadForm = document.getElementById('create-thread-form');
        window.openThreadModal = () => { if(!currentUser) return alertRequiredLogin(); threadModal.classList.remove('hidden-section'); };
        window.closeThreadModal = () => threadModal.classList.add('hidden-section');
        threadForm.addEventListener('submit', async (e) => { e.preventDefault(); const title = document.getElementById('thread-title').value; const content = document.getElementById('thread-content').value; const tag = document.getElementById('thread-tag').value; try { await addDoc(collection(db, "forum_threads"), { title, content, tag, uid: currentUser.uid, author: userData.username, avatar: userData.avatar, frame: userData.frame, likes: 0, commentCount: 0, createdAt: serverTimestamp() }); closeThreadModal(); threadForm.reset(); } catch (err) { console.error(err); } });

        let currentThreadId = null;
        window.openViewModal = async (id) => { currentThreadId = id; const thread = allThreads.find(t => t.id === id); if (!thread) return; document.getElementById('view-thread-title').innerText = thread.title; document.getElementById('view-thread-content').innerText = thread.content; document.getElementById('view-thread-author').innerText = thread.author; document.getElementById('view-thread-date').innerText = new Date(thread.createdAt.toDate()).toLocaleString(); const hasLiked = localStorage.getItem(`like_${id}`); const likeColor = hasLiked ? 'text-red-500' : 'text-gray-500 hover:text-red-500'; document.getElementById('view-thread-tags').innerHTML = `<span class="tag-badge bg-[#222] border-white/20">${thread.tag}</span><button onclick="likeThread('${id}')" class="ml-4 ${likeColor} transition font-bold"><i class="fa-solid fa-heart"></i> <span id="modal-likes">${thread.likes || 0}</span></button>`; const commentsRef = collection(db, "forum_threads", id, "comments"); const qComm = query(commentsRef, orderBy("createdAt", "asc")); onSnapshot(qComm, (snap) => { const list = document.getElementById('comments-list'); list.innerHTML = ""; if(snap.empty) list.innerHTML = '<div class="text-gray-600 text-sm">S√© el primero en responder.</div>'; snap.forEach(doc => { const c = doc.data(); const cFrame = c.frame || ''; const cAvatar = (c.avatar && c.avatar.length > 10) ? c.avatar : "https://via.placeholder.com/40"; const html = `<div class="flex gap-3 animate-[fadeIn_0.2s]"><div class="avatar-container ${cFrame} flex-shrink-0" style="padding:2px; width:fit-content; height:fit-content;"><img src="${cAvatar}" class="w-8 h-8 rounded-full border border-gray-600"></div><div class="flex-1"><div class="flex justify-between items-baseline"><span class="text-sm font-bold text-[#F47521]">${c.username}</span><button onclick="requestDeleteComment('${id}', '${doc.id}')" class="btn-delete text-xs"><i class="fa-solid fa-trash"></i></button></div><p class="text-gray-400 text-sm mt-1 bg-[#1a1a1a] p-2 rounded-lg border border-white/5">${c.text}</p></div></div>`; list.insertAdjacentHTML('beforeend', html); }); }); document.getElementById('view-thread-modal').classList.remove('hidden-section'); };
        window.closeViewModal = () => document.getElementById('view-thread-modal').classList.add('hidden-section');
        document.getElementById('comment-form').addEventListener('submit', async (e) => { e.preventDefault(); if(!currentUser) return alertRequiredLogin(); const text = document.getElementById('comment-input').value; try { await addDoc(collection(db, "forum_threads", currentThreadId, "comments"), { text, uid: currentUser.uid, username: userData.username, avatar: userData.avatar, frame: userData.frame, createdAt: serverTimestamp() }); await updateDoc(doc(db, "forum_threads", currentThreadId), { commentCount: increment(1) }); document.getElementById('comment-input').value = ""; } catch(err) { console.error(err); } });
        window.likeThread = async (id) => { if(!currentUser) return alertRequiredLogin(); if(localStorage.getItem(`like_${id}`)) { alert("Ya diste like."); return; } const ref = doc(db, "forum_threads", id); await updateDoc(ref, { likes: increment(1) }); localStorage.setItem(`like_${id}`, 'true'); const count = document.getElementById('modal-likes'); if(count) count.innerText = parseInt(count.innerText) + 1; };

        let deleteTargetId = null; let deleteCollection = null; let deleteSubId = null;
        window.requestDelete = (id, collection) => { deleteTargetId = id; deleteCollection = collection; deleteSubId = null; openDeleteModal(); };
        window.requestDeleteComment = (threadId, commentId) => { deleteTargetId = threadId; deleteCollection = "forum_threads"; deleteSubId = commentId; openDeleteModal(); };
        function openDeleteModal() { document.getElementById('delete-modal').classList.remove('hidden-section'); document.getElementById('delete-key').value = ""; }
        window.closeDeleteModal = () => document.getElementById('delete-modal').classList.add('hidden-section');
        window.confirmDelete = async () => { const key = document.getElementById('delete-key').value; if (key === "#Lau3700#") { try { if (deleteSubId) { await deleteDoc(doc(db, "forum_threads", deleteTargetId, "comments", deleteSubId)); await updateDoc(doc(db, "forum_threads", deleteTargetId), { commentCount: increment(-1) }); } else { await deleteDoc(doc(db, deleteCollection, deleteTargetId)); } closeDeleteModal(); } catch (e) { alert("Error: " + e.message); } } else { alert("CLAVE INCORRECTA"); } };
        window.openClearChatModal = () => { document.getElementById('clear-chat-modal').classList.remove('hidden-section'); document.getElementById('clear-chat-key').value = ""; };
        window.closeClearChatModal = () => document.getElementById('clear-chat-modal').classList.add('hidden-section');
        window.confirmClearChat = async () => { const key = document.getElementById('clear-chat-key').value; if (key === "#Lau3700#") { const btn = document.querySelector('#clear-chat-modal button'); btn.innerText = "BORRANDO..."; try { const q = query(collection(db, "global_chat"), limit(500)); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.docs.forEach((doc) => { batch.delete(doc.ref); }); await batch.commit(); alert("Chat Global eliminado."); closeClearChatModal(); } catch (e) { alert("Error: " + e.message); } finally { btn.innerText = "EJECUTAR LIMPIEZA"; } } else { alert("CLAVE INCORRECTA"); } };

    </script>

    <script src="https://sonsstoop.com/da/86/f2/da86f249d98873f9fffa9b93a47f25fe.js"></script>

    <script src="https://sonsstoop.com/93/e0/df/93e0df4f61a1be1b4c70381a502a2fcd.js"></script>
    
</body>
    
</html>


